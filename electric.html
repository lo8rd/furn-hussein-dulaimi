<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุตููู ุงูููุฑุจุงุฆู - ูุฑู ุญุณูู ุงูุฏูููู</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="512x512" href="dul.png">
    <link rel="icon" type="image/png" sizes="192x192" href="dul.png">
    <link rel="icon" type="image/png" sizes="32x32" href="dul.png">
    <link rel="icon" type="image/png" sizes="16x16" href="dul.png">
    <link rel="apple-touch-icon" sizes="180x180" href="dul.png">
    <meta name="theme-color" content="#FFD700">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <button onclick="logout()" class="logout-btn">
                <span>๐ช</span>
                <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
            </button>
            <h1>โก ุงูุตููู ุงูููุฑุจุงุฆู โก</h1>
            <p>ุญุณุงุจ ุฃุฑุจุงุญ ุงูฺุฑู ูุงูุฏุงุฆุฑู</p>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                <li><a href="dough.html">ุงูุนุฌูุงุช ุงูููููุฉ</a></li>
                <li><a href="electric.html" class="active"> ุงูููุฑุจุงุฆู</a></li>
                <li><a href="differences.html">ุงููุฑููุงุช</a></li>
                <li><a href="dough_records.html">ุณุฌู ุงูุนุฌูุงุช</a></li>
                <li><a href="expenses.html">ุงููุตุงุฑูู</a></li>
            </ul>
        </nav>

        <!-- ูููุฐุฌ ุงูุญุณุงุจ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">ุฅุถุงูุฉ ุตููู ููุฑุจุงุฆู</h2>
            
            <div id="alertMessage"></div>

            <form id="electricForm">
                <div class="form-group">
                    <label for="date">ุงูุชุงุฑูุฎ</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="jerqCount">ุนุฏุฏ ุงูฺุฑู</label>
                    <input type="number" id="jerqCount" name="jerqCount" min="0" placeholder="ุฃุฏุฎู ุงูุนุฏุฏ" required>
                </div>

                <div class="form-group">
                    <label for="circleCount">ุนุฏุฏ ุงูุฏุงุฆุฑู</label>
                    <input type="number" id="circleCount" name="circleCount" min="0" placeholder="ุฃุฏุฎู ุงูุนุฏุฏ" required>
                    <small style="color: var(--light-gray); display: block; margin-top: 5px;">
                        (ุงูุชุณุนูุฑุฉ: 1=250ุ 3=500ุ 4=750ุ 6=1000)
                    </small>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-title">ุฑุจุญ ุงูฺุฑู</div>
                        <div class="card-value" id="jerqProfit">0</div>
                        <div class="card-label">ุฏููุงุฑ</div>
                    </div>

                    <div class="card">
                        <div class="card-title">ุฑุจุญ ุงูุฏุงุฆุฑู</div>
                        <div class="card-value" id="circleProfit">0</div>
                        <div class="card-label">ุฏููุงุฑ</div>
                    </div>

                    <div class="card" style="border: 2px solid var(--gold);">
                        <div class="card-title">ุงูุฑุจุญ ุงูุฅุฌูุงูู</div>
                        <div class="card-value" id="totalProfit" style="color: var(--gold); font-size: 3rem;">0</div>
                        <div class="card-label">ุฏููุงุฑ</div>
                    </div>
                </div>

                <!-- ูุณู ุงูุชูู ุงูููุฑุจุงุฆู -->
                <div style="margin-top: 30px; padding: 20px; background: var(--secondary-black); border-radius: 10px; border: 2px solid var(--danger);">
                    <h3 style="color: var(--danger); margin-bottom: 15px; text-align: center;">
                        ๐ป ูุณู ุงูุชูู ุงูููุฑุจุงุฆู
                    </h3>
                    
                    <div class="form-group">
                        <label for="wasteJerqCount">ุชูู ุงูฺุฑู (ุนุฏุฏ ุงููุทุน)</label>
                        <input type="number" id="wasteJerqCount" name="wasteJerqCount" min="0" value="0" placeholder="0">
                        <small style="color: var(--light-gray); display: block; margin-top: 5px;">
                            ุณุนุฑ ุงููุทุนุฉ: 250 ุฏููุงุฑ
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="wasteRoundCount">ุชูู ุงูุฏุงุฆุฑู (ุนุฏุฏ ุงููุทุน)</label>
                        <input type="number" id="wasteRoundCount" name="wasteRoundCount" min="0" value="0" placeholder="0">
                        <small style="color: var(--light-gray); display: block; margin-top: 5px;">
                            ุงูุชุณุนูุฑุฉ: 3=500ุ 4=750ุ 6=1000
                        </small>
                    </div>

                    <div class="cards-grid" style="margin-top: 15px;">
                        <div class="card" style="background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger);">
                            <div class="card-title" style="color: var(--danger);">ุชูู ฺุฑู</div>
                            <div class="card-value" id="wasteJerqTotal" style="color: var(--danger);">0</div>
                            <div class="card-label">ุฏููุงุฑ</div>
                        </div>

                        <div class="card" style="background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger);">
                            <div class="card-title" style="color: var(--danger);">ุชูู ุฏุงุฆุฑู</div>
                            <div class="card-value" id="wasteRoundTotal" style="color: var(--danger);">0</div>
                            <div class="card-label">ุฏููุงุฑ</div>
                        </div>

                        <div class="card" style="background: rgba(220, 53, 69, 0.2); border: 2px solid var(--danger);">
                            <div class="card-title" style="color: var(--danger);">ุฅุฌูุงูู ุงูุชูู</div>
                            <div class="card-value" id="totalWaste" style="color: var(--danger); font-size: 2rem;">0</div>
                            <div class="card-label">ุฏููุงุฑ</div>
                        </div>
                    </div>
                </div>

                <!-- ุตุงูู ุงูุฑุจุญ -->
                <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%); border: 3px solid var(--gold);">
                    <div class="card-title" style="color: var(--white);">ุตุงูู ุงูุฑุจุญ (ุจุนุฏ ุฎุตู ุงูุชูู)</div>
                    <div class="card-value" id="netProfit" style="color: var(--white); font-size: 3rem;">0</div>
                    <div class="card-label" style="color: var(--white);">ุฏููุงุฑ</div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success">ุญูุธ ุงูุจูุงูุงุช</button>
                    <button type="button" class="btn btn-primary" onclick="resetForm()">ูุณุญ ุงูุญููู</button>
                </div>
            </form>
        </div>

        <!-- ูุฌููุน ุงูููู -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">ูุฌููุน ุงูููู</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">ุฅุฌูุงูู ุงูฺุฑู ุงูููู</div>
                    <div class="card-value" id="todayJerqCount">0</div>
                    <div class="card-label">ูุทุนุฉ</div>
                </div>

                <div class="card">
                    <div class="card-title">ุฅุฌูุงูู ุงูุฏุงุฆุฑู ุงูููู</div>
                    <div class="card-value" id="todayCircleCount">0</div>
                    <div class="card-label">ูุทุนุฉ</div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, var(--gold) 0%, var(--dark-gold) 100%);">
                    <div class="card-title" style="color: var(--primary-black);">ุฅุฌูุงูู ุฑุจุญ ุงูููู</div>
                    <div class="card-value" id="todayTotalProfit" style="color: var(--primary-black); font-size: 2.5rem;">0</div>
                    <div class="card-label" style="color: var(--primary-black);">ุฏููุงุฑ</div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูุณุฌูุงุช -->
        <div class="table-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">ุณุฌู ุงููุจูุนุงุช</h2>
            
            <div id="electricTableContainer">
                <table id="electricTable">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ฺุฑู</th>
                            <th>ุฏุงุฆุฑู</th>
                            <th>ุงูุฑุจุญ ุงูุฅุฌูุงูู</th>
                            <th>ุงูุชูู</th>
                            <th>ุตุงูู ุงูุฑุจุญ</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="electricTableBody">
                        <!-- ุณูุชู ููุคู ุชููุงุฆูุงู -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ูุนูููุงุช ุงูุชุณุนูุฑ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">๐ ูุนูููุงุช ุงูุชุณุนูุฑ</h2>
            
            <div style="background: var(--primary-black); padding: 20px; border-radius: 10px;">
                <h3 style="color: var(--gold); margin-bottom: 15px;">๐ธ ุงูฺุฑู:</h3>
                <p style="color: var(--white); font-size: 1.1rem; margin-bottom: 20px;">
                    ุณุนุฑ ุงููุทุนุฉ ุงููุงุญุฏุฉ: <strong style="color: var(--gold);">250 ุฏููุงุฑ</strong>
                </p>

                <h3 style="color: var(--gold); margin-bottom: 15px;">๐ธ ุงูุฏุงุฆุฑู ุงูููุฑุจุงุฆู:</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="background: var(--secondary-black); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>1 ูุทุนุฉ</span>
                        <strong style="color: var(--gold);">250 ุฏููุงุฑ</strong>
                    </div>
                    <div style="background: var(--secondary-black); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>3 ูุทุน</span>
                        <strong style="color: var(--gold);">500 ุฏููุงุฑ</strong>
                    </div>
                    <div style="background: var(--secondary-black); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span>4 ูุทุน</span>
                        <strong style="color: var(--gold);">750 ุฏููุงุฑ</strong>
                    </div>
                    <div style="background: var(--secondary-black); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; border: 2px solid var(--gold);">
                        <span>6 ูุทุน</span>
                        <strong style="color: var(--gold);">1,000 ุฏููุงุฑ</strong>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: var(--secondary-black); border-radius: 8px; border-right: 4px solid var(--gold);">
                    <h4 style="color: var(--gold); margin-bottom: 10px;">๐ก ูุซุงู ุนูู ุงูุญุณุงุจ:</h4>
                    <p style="color: var(--light-gray);">
                        ุฅุฐุง ุฃุฏุฎูุช <strong>10 ูุทุน ุฏุงุฆุฑู</strong>:<br>
                        6 ูุทุน = 1,000 ุฏููุงุฑ<br>
                        4 ูุทุน = 750 ุฏููุงุฑ<br>
                        <strong style="color: var(--gold);">ุงููุฌููุน = 1,750 ุฏููุงุฑ</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="db.js"></script>
    <script src="auth-check.js"></script>
    <script>
        let editingId = null;

        // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู ุชููุงุฆูุงู
        document.getElementById('date').valueAsDate = new Date();

        // ุญุณุงุจ ุงูุฑุจุญ ูุงูุชูู ุชููุงุฆูุงู ุนูุฏ ุงูุชุบููุฑ
        document.getElementById('jerqCount').addEventListener('input', calculateProfit);
        document.getElementById('circleCount').addEventListener('input', calculateProfit);
        document.getElementById('wasteJerqCount').addEventListener('input', calculateProfit);
        document.getElementById('wasteRoundCount').addEventListener('input', calculateProfit);

        function calculateProfit() {
            const jerqCount = parseInt(document.getElementById('jerqCount').value) || 0;
            const circleCount = parseInt(document.getElementById('circleCount').value) || 0;
            const wasteJerqCount = parseInt(document.getElementById('wasteJerqCount').value) || 0;
            const wasteRoundCount = parseInt(document.getElementById('wasteRoundCount').value) || 0;

            // ุญุณุงุจ ุงูุฑุจุญ
            const jerqProfit = jerqCount * 250;
            const circleProfit = db.calculateCirclePrice(circleCount);
            const totalProfit = jerqProfit + circleProfit;

            // ุญุณุงุจ ุงูุชูู
            const wasteJerqTotal = wasteJerqCount * 250;
            const wasteRoundTotal = db.calculateCirclePrice(wasteRoundCount);
            const totalWaste = wasteJerqTotal + wasteRoundTotal;

            // ุตุงูู ุงูุฑุจุญ
            const netProfit = totalProfit - totalWaste;

            // ุนุฑุถ ุงูุฃุฑูุงู ูุจุงุดุฑุฉ ุจุฏูู ุฃููููุดู (ูููุนุงููุฉ ุงูููุฑูุฉ)
            document.getElementById('jerqProfit').textContent = formatNumber(jerqProfit);
            document.getElementById('circleProfit').textContent = formatNumber(circleProfit);
            document.getElementById('totalProfit').textContent = formatNumber(totalProfit);
            
            document.getElementById('wasteJerqTotal').textContent = formatNumber(wasteJerqTotal);
            document.getElementById('wasteRoundTotal').textContent = formatNumber(wasteRoundTotal);
            document.getElementById('totalWaste').textContent = formatNumber(totalWaste);
            
            document.getElementById('netProfit').textContent = formatNumber(netProfit);
        }

        // ุชุญุฑูู ุงูุฃุฑูุงู (Animation)
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseFloat(element.textContent.replace(/,/g, '')) || 0;
            const duration = 600;
            const increment = (targetValue - startValue) / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) || (increment < 0 && currentValue <= targetValue)) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = formatNumber(Math.round(currentValue));
            }, 16);
        }

        // ุญูุธ ุงูุจูุงูุงุช
        document.getElementById('electricForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                date: document.getElementById('date').value,
                jerq_count: document.getElementById('jerqCount').value,
                circle_count: document.getElementById('circleCount').value,
                waste_jerq_count: document.getElementById('wasteJerqCount').value || 0,
                waste_round_count: document.getElementById('wasteRoundCount').value || 0
            };

            try {
                if (editingId) {
                    // ุชุญุฏูุซ ุงูุณุฌู
                    await db.updateElectricBread(editingId, formData);
                    showAlert('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ!', 'success');
                    editingId = null;
                } else {
                    // ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
                    await db.addElectricBread(formData);
                    showAlert('ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ!', 'success');
                }

                resetForm();
                await loadElectricTable();
                await loadTodayStats();
            } catch (error) {
                console.error('Error saving electric bread:', error);
                showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ: ' + error.message, 'danger');
            }
        });

        // ูุณุญ ุงูุญููู
        function resetForm() {
            document.getElementById('electricForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            editingId = null;
            document.getElementById('jerqProfit').textContent = '0';
            document.getElementById('circleProfit').textContent = '0';
            document.getElementById('totalProfit').textContent = '0';
            document.getElementById('wasteJerqTotal').textContent = '0';
            document.getElementById('wasteRoundTotal').textContent = '0';
            document.getElementById('totalWaste').textContent = '0';
            document.getElementById('netProfit').textContent = '0';
        }

        // ุนุฑุถ ุฑุณุงูุฉ ุชูุจูู
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        // ุชุญููู ุฌุฏูู ุงูุณุฌูุงุช
        async function loadElectricTable() {
            const records = (await db.getAllElectricBread()).sort((a, b) => {
                if (b.date === a.date) {
                    return b.id - a.id;
                }
                return new Date(b.date) - new Date(a.date);
            });
            const tbody = document.getElementById('electricTableBody');

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">๐</div>
                            <p>ูุง ุชูุฌุฏ ุณุฌูุงุช ุจุนุฏ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.map(record => {
                const totalProfit = record.total_profit || (record.jerq_total + record.circle_total) || 0;
                const totalWaste = record.total_waste || 0;
                const netProfit = record.net_profit || (totalProfit - totalWaste);
                
                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>${formatNumber(record.jerq_count)} ูุทุนุฉ</td>
                        <td>${formatNumber(record.circle_count)} ูุทุนุฉ</td>
                        <td style="color: var(--gold);">${formatNumber(totalProfit)}</td>
                        <td style="color: var(--danger);">${formatNumber(totalWaste)}</td>
                        <td><strong style="color: var(--success);">${formatNumber(netProfit)}</strong></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;" onclick="editRecord('${record.id}')">ุชุนุฏูู</button>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;" onclick="deleteRecord('${record.id}')">ุญุฐู</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ุชุญููู ุฅุญุตุงุฆูุงุช ุงูููู
        async function loadTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = await db.getElectricBreadByDate(today);

            const totalJerq = todayRecords.reduce((sum, r) => sum + r.jerq_count, 0);
            const totalCircle = todayRecords.reduce((sum, r) => sum + r.circle_count, 0);
            const totalProfit = todayRecords.reduce((sum, r) => {
                const profit = r.net_profit || r.total_profit_day || r.total_profit || 0;
                return sum + profit;
            }, 0);

            document.getElementById('todayJerqCount').textContent = formatNumber(totalJerq);
            document.getElementById('todayCircleCount').textContent = formatNumber(totalCircle);
            document.getElementById('todayTotalProfit').textContent = formatNumber(totalProfit);
        }

        // ุชุนุฏูู ุณุฌู
        async function editRecord(id) {
            const records = await db.getAllElectricBread();
            const record = records.find(r => r.id === id);
            
            if (record) {
                document.getElementById('date').value = record.date;
                document.getElementById('jerqCount').value = record.jerq_count;
                document.getElementById('circleCount').value = record.circle_count;
                document.getElementById('wasteJerqCount').value = record.waste_jerq_count || 0;
                document.getElementById('wasteRoundCount').value = record.waste_round_count || 0;
                calculateProfit();
                editingId = id;
                
                // ุงูุชูุฑูุฑ ููุฃุนูู
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showAlert('ุฌุงุฑู ุงูุชุนุฏูู... ูู ุจุชุญุฏูุซ ุงูููู ูุงุถุบุท ุญูุธ', 'info');
            }
        }

        // ุญุฐู ุณุฌู
        async function deleteRecord(id) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ')) {
                try {
                    await db.deleteElectricBread(id);
                    showAlert('ุชู ุญุฐู ุงูุณุฌู ุจูุฌุงุญ!', 'success');
                    await loadElectricTable();
                    await loadTodayStats();
                } catch (error) {
                    console.error('Error deleting electric bread:', error);
                    showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู', 'danger');
                }
            }
        }

        // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadElectricTable();
            await loadTodayStats();
            // ูุง ูุณุชุฏุนู calculateProfit() ููุง ูุฃู ุงูุญููู ูุงุฑุบุฉ
        });
    </script>
</body>
</html>

