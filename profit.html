<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุญุณุงุจ ุงูุฑุจุญ ุงูููุงุฆู - ูุฑู ุญุณูู ุงูุฏูููู</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <button onclick="logout()" class="logout-btn">
                <span>๐ช</span>
                <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
            </button>
            <h1>๐ ุญุณุงุจ ุงูุฑุจุญ ุงูููุงุฆู ๐</h1>
            <p>ุชูุงุฑูุฑ ูุฅุญุตุงุฆูุงุช ููุตูุฉ</p>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                <li><a href="dough.html">ุงูุนุฌูุงุช ุงูููููุฉ</a></li>
                <li><a href="electric.html"> ุงูููุฑุจุงุฆู</a></li>
                <li><a href="differences.html">ุงููุฑููุงุช</a></li>
                <li><a href="dough_records.html">ุณุฌู ุงูุนุฌูุงุช</a></li>
                <li><a href="expenses.html">ุงููุตุงุฑูู</a></li>
                <li><a href="profit.html" class="active">ุงูุฑุจุญ ุงูููุงุฆู</a></li>
            </ul>
        </nav>

        <!-- ุงุฎุชูุงุฑ ุงููุชุฑุฉ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">ุงุฎุชุฑ ุงููุชุฑุฉ</h2>
            
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="loadProfitReport('today', event)">ุงูููู</button>
                <button class="tab-btn" onclick="loadProfitReport('week', event)">ูุฐุง ุงูุฃุณุจูุน</button>
                <button class="tab-btn" onclick="loadProfitReport('month', event)">ูุฐุง ุงูุดูุฑ</button>
            </div>
        </div>

        <!-- ููุฎุต ุงูุฑุจุญ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">ููุฎุต ุงูุฑุจุญ</h2>
            
            <div class="cards-grid">
                <div class="card" style="background: linear-gradient(135deg, #2d2d2d 0%, #1a5f3a 100%);">
                    <div class="card-title">โ ุฑุจุญ ุงูุนุฌูุงุช</div>
                    <div class="card-value" id="totalDoughProfit">0</div>
                    <div class="card-label">ุฃูู ุฏููุงุฑ</div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #2d2d2d 0%, #8b4513 100%);">
                    <div class="card-title">๐พ ูููุฉ ุงูุทุญูู</div>
                    <div class="card-value" id="totalFlourCost">0</div>
                    <div class="card-label">ุฃูู ุฏููุงุฑ</div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #2d2d2d 0%, #c82333 100%);">
                    <div class="card-title">๐ฐ ุงููุตุงุฑูู</div>
                    <div class="card-value" id="totalExpenses">0</div>
                    <div class="card-label">ุฃูู ุฏููุงุฑ</div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #2d2d2d 0%, #FFD700 100%); border: 3px solid var(--gold);">
                    <div class="card-title" style="color: var(--primary-black);">๐ ุตุงูู ุงูุฑุจุญ</div>
                    <div class="card-value" id="netProfit" style="color: var(--primary-black); font-size: 3rem;">0</div>
                    <div class="card-label" style="color: var(--primary-black);">ุฃูู ุฏููุงุฑ</div>
                </div>
            </div>

            <p style="text-align: center; color: var(--light-gray); margin-top: 15px; font-size: 0.9rem;">
                ๐ก ุฌููุน ุงููุจุงูุบ ูุนุฑูุถุฉ ุจุงูุฃูู ุฏููุงุฑ ููุชุจุณูุท (ูุซูุงู: 150 = 150,000 ุฏููุงุฑ)
            </p>
        </div>

        <!-- ุชูุงุตูู ุงูุญุณุงุจุงุช -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">ุชูุงุตูู ุงูุญุณุงุจุงุช</h2>
            
            <div style="background: var(--primary-black); padding: 30px; border-radius: 10px; font-size: 1.2rem; line-height: 2;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>ุฑุจุญ ุงูุนุฌูุงุช:</span>
                    <span style="color: var(--success); font-weight: bold;">+ <span id="detailDoughProfit">0</span> ุฏููุงุฑ</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>ูููุฉ ุงูุทุญูู:</span>
                    <span style="color: var(--danger); font-weight: bold;">- <span id="detailFlourCost">0</span> ุฏููุงุฑ</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>ุงููุตุงุฑูู:</span>
                    <span style="color: var(--danger); font-weight: bold;">- <span id="detailExpenses">0</span> ุฏููุงุฑ</span>
                </div>
                
                <hr style="border: 2px solid var(--gold); margin: 20px 0;">
                
                <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold;">
                    <span style="color: var(--gold);">ุตุงูู ุงูุฑุจุญ:</span>
                    <span style="color: var(--gold);">= <span id="detailNetProfit">0</span> ุฏููุงุฑ</span>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุฅุถุงููุฉ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">ุฅุญุตุงุฆูุงุช ุฅุถุงููุฉ</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">ุนุฏุฏ ุงูุนุฌูุงุช</div>
                    <div class="card-value" id="totalDoughCount">0</div>
                    <div class="card-label">ุนุฌูุฉ</div>
                </div>

                <div class="card">
                    <div class="card-title">ูุชูุณุท ุงูุฑุจุญ ุงููููู</div>
                    <div class="card-value" id="avgDailyProfit">0</div>
                    <div class="card-label">ุฏููุงุฑ</div>
                </div>

                <div class="card">
                    <div class="card-title">ูุณุจุฉ ุงูุฑุจุญ</div>
                    <div class="card-value" id="profitMargin">0</div>
                    <div class="card-label">%</div>
                </div>

                <div class="card">
                    <div class="card-title">ุนุฏุฏ ุฃูุงู ุงูุนูู</div>
                    <div class="card-value" id="workingDays">0</div>
                    <div class="card-label">ููู</div>
                </div>
            </div>
        </div>

        <!-- ุฌุฏูู ุงูููุงุฑูุฉ ุงูููููุฉ -->
        <div class="table-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">ุงูููุงุฑูุฉ ุงูููููุฉ</h2>
            
            <div id="dailyComparisonContainer">
                <table id="dailyComparisonTable">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุนุฌูุงุช</th>
                            <th>ุงูุฑุจุญ</th>
                            <th>ุงูุทุญูู</th>
                            <th>ุงููุตุงุฑูู</th>
                            <th>ุตุงูู ุงูุฑุจุญ</th>
                        </tr>
                    </thead>
                    <tbody id="dailyComparisonBody">
                        <!-- ุณูุชู ููุคู ุชููุงุฆูุงู -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุชุญููุฒูุฉ -->
        <div class="form-container" style="text-align: center; background: linear-gradient(135deg, var(--gold) 0%, var(--dark-gold) 100%);">
            <h2 style="color: var(--primary-black); margin-bottom: 15px;">๐ ุจุฑูุงุช ุงูุฑุถุง ูุนูู ๐</h2>
            <p style="color: var(--primary-black); font-size: 1.2rem; font-weight: 600;">
                ุงุณุชูุฑูุง ูู ุงูุนูู ุงูุฌุงุฏ ูุจุงุฑู ุงููู ูู ุฑุฒููู
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="db.js"></script>
    <script src="auth-check.js"></script>
    <script>
        let currentPeriod = 'today';

        // ุชุญููู ุชูุฑูุฑ ุงูุฑุจุญ
        async function loadProfitReport(period, e = null) {
            currentPeriod = period;

            // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ุชูุนูู ุงูุฒุฑ ุงูููุงุณุจ
            if (e && e.target) {
                e.target.classList.add('active');
            } else {
                // ุนูุฏ ุงูุชุญููู ุงูุฃููุ ุชูุนูู ุงูุฒุฑ ุญุณุจ ุงููุชุฑุฉ
                const buttons = document.querySelectorAll('.tab-btn');
                if (period === 'today') buttons[0]?.classList.add('active');
                else if (period === 'week') buttons[1]?.classList.add('active');
                else if (period === 'month') buttons[2]?.classList.add('active');
            }

            // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช
            const [doughData, flourData, expensesData] = await Promise.all([
                db.getAllDough(),
                db.getAllFlour(),
                db.getAllExpenses()
            ]);

            // ุชุญุฏูุฏ ุงููุชุฑุฉ
            let periodAgo = new Date();
            if (period === 'today') {
                periodAgo = new Date();
            } else if (period === 'week') {
                periodAgo.setDate(periodAgo.getDate() - 7);
            } else if (period === 'month') {
                periodAgo.setMonth(periodAgo.getMonth() - 1);
            }
            const periodAgoStr = periodAgo.toISOString().split('T')[0];
            const todayStr = new Date().toISOString().split('T')[0];

            // ุชุตููุฉ ุงูุจูุงูุงุช ุญุณุจ ุงููุชุฑุฉ
            let filteredDough, filteredFlour, filteredExpenses;

            if (period === 'today') {
                filteredDough = doughData.filter(d => d.date === todayStr);
                filteredFlour = flourData.filter(f => f.date === todayStr);
                filteredExpenses = expensesData.filter(e => e.date === todayStr);
            } else {
                filteredDough = doughData.filter(d => d.date >= periodAgoStr);
                filteredFlour = flourData.filter(f => f.date >= periodAgoStr);
                filteredExpenses = expensesData.filter(e => e.date >= periodAgoStr);
            }

            // ุญุณุงุจ ุงููุฌุงููุน
            const totalDoughCount = filteredDough.reduce((sum, d) => sum + d.morning_count + d.evening_count, 0);
            const totalDoughProfit = filteredDough.reduce((sum, d) => sum + d.total_profit, 0);
            const totalFlourCost = filteredFlour.reduce((sum, f) => sum + f.total_cost, 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalDoughProfit - totalFlourCost - totalExpenses;

            // ุชุญุฏูุซ ุงูุจุทุงูุงุช ุงูุฑุฆูุณูุฉ
            animateNumber('totalDoughProfit', totalDoughProfit, true);
            animateNumber('totalFlourCost', totalFlourCost, true);
            animateNumber('totalExpenses', totalExpenses, true);
            animateNumber('netProfit', netProfit, true);

            // ุชุญุฏูุซ ุชูุงุตูู ุงูุญุณุงุจุงุช
            document.getElementById('detailDoughProfit').textContent = formatThousands(totalDoughProfit);
            document.getElementById('detailFlourCost').textContent = formatThousands(totalFlourCost);
            document.getElementById('detailExpenses').textContent = formatThousands(totalExpenses);
            document.getElementById('detailNetProfit').textContent = formatThousands(netProfit);

            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุฅุถุงููุฉ
            const workingDays = filteredDough.length;
            const avgDailyProfit = workingDays > 0 ? netProfit / workingDays : 0;
            const profitMargin = totalDoughProfit > 0 ? (netProfit / totalDoughProfit) * 100 : 0;

            document.getElementById('totalDoughCount').textContent = formatNumber(totalDoughCount, 0);
            document.getElementById('avgDailyProfit').textContent = formatThousands(avgDailyProfit);
            document.getElementById('profitMargin').textContent = profitMargin.toFixed(1);
            document.getElementById('workingDays').textContent = formatNumber(workingDays, 0);

            // ุชุญุฏูุซ ุฌุฏูู ุงูููุงุฑูุฉ ุงูููููุฉ
            loadDailyComparison(period);
        }

        // ุชุญููู ุฌุฏูู ุงูููุงุฑูุฉ ุงูููููุฉ
        function loadDailyComparison(period) {
            const doughData = db.getAllDough();
            const flourData = db.getAllFlour();
            const expensesData = db.getAllExpenses();

            // ุชุญุฏูุฏ ุงููุชุฑุฉ
            let periodAgo = new Date();
            if (period === 'today') {
                periodAgo = new Date();
            } else if (period === 'week') {
                periodAgo.setDate(periodAgo.getDate() - 7);
            } else if (period === 'month') {
                periodAgo.setMonth(periodAgo.getMonth() - 1);
            }
            const periodAgoStr = periodAgo.toISOString().split('T')[0];
            const todayStr = new Date().toISOString().split('T')[0];

            // ุฌูุน ูู ุงูุชูุงุฑูุฎ
            const allDates = new Set();
            
            if (period === 'today') {
                allDates.add(todayStr);
            } else {
                doughData.forEach(d => {
                    if (d.date >= periodAgoStr) allDates.add(d.date);
                });
                flourData.forEach(f => {
                    if (f.date >= periodAgoStr) allDates.add(f.date);
                });
                expensesData.forEach(e => {
                    if (e.date >= periodAgoStr) allDates.add(e.date);
                });
            }

            const sortedDates = Array.from(allDates).sort((a, b) => new Date(b) - new Date(a));

            const tbody = document.getElementById('dailyComparisonBody');

            if (sortedDates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">๐</div>
                            <p>ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐู ุงููุชุฑุฉ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedDates.map(date => {
                const dough = doughData.find(d => d.date === date);
                const flour = flourData.find(f => f.date === date);
                const dayExpenses = expensesData.filter(e => e.date === date);

                const doughCount = dough ? dough.morning_count + dough.evening_count : 0;
                const profit = dough ? dough.total_profit : 0;
                const flourCost = flour ? flour.total_cost : 0;
                const expenseCost = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
                const netProfit = profit - flourCost - expenseCost;

                const profitColor = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${formatNumber(doughCount, 0)}</td>
                        <td>${formatThousands(profit)}</td>
                        <td>${formatThousands(flourCost)}</td>
                        <td>${formatThousands(expenseCost)}</td>
                        <td style="color: ${profitColor}; font-weight: bold;">${formatThousands(netProfit)}</td>
                    </tr>
                `;
            }).join('');
        }

        // ุชุญุฑูู ุงูุฃุฑูุงู (Animation)
        function animateNumber(elementId, targetValue, useThousands = false) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 1000;
            const targetNum = parseFloat(targetValue);
            const increment = targetNum / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetNum) || (increment < 0 && currentValue <= targetNum)) {
                    currentValue = targetNum;
                    clearInterval(timer);
                }
                if (useThousands) {
                    element.textContent = formatThousands(currentValue);
                } else {
                    element.textContent = formatNumber(currentValue);
                }
            }, 16);
        }

        // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfitReport('today');
        });
    </script>
</body>
</html>

