<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ - ÙØ±Ù† Ø­Ø³ÙŠÙ† Ø§Ù„Ø¯Ù„ÙŠÙ…ÙŠ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <button onclick="logout()" class="logout-btn">
                <span>ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
            <h1>ğŸ’° Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ğŸ’°</h1>
            <p>ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙØ±Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="dough.html">Ø§Ù„Ø¹Ø¬Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</a></li>
                <li><a href="electric.html"> Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</a></li>
                <li><a href="differences.html">Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</a></li>
                <li><a href="dough_records.html">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø¬Ù†Ø§Øª</a></li>
                <li><a href="expenses.html" class="active">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</a></li>
                <li><a href="profit.html">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</a></li>
            </ul>
        </nav>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h2>
            
            <div id="alertMessage"></div>

            <form id="expensesForm">
                <div class="form-group">
                    <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="expenseName">Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                    <input type="text" id="expenseName" name="expenseName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ ØµÙŠØ§Ù†Ø©ØŒ ÙˆÙ‚ÙˆØ¯..." required>
                </div>

                <div class="form-group">
                    <label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
                    <input type="text" id="amount" name="amount" placeholder="Ù…Ø«Ø§Ù„: 5,000 Ø£Ùˆ 1250" required>
                    <small style="color: var(--light-gray); display: block; margin-top: 5px;">
                        ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ Ù…Ø«Ù„: 1,250 Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… Ù…Ø¨Ø§Ø´Ø±Ø©: 5000
                    </small>
                </div>

                <div class="cards-grid" style="grid-template-columns: 1fr;">
                    <div class="card">
                        <div class="card-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨Ù„Øº</div>
                        <div class="card-value" id="displayAmount">0</div>
                        <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                    </div>
                </div>

                <p style="text-align: center; color: var(--light-gray); margin-top: 15px; font-size: 0.9rem;">
                    ğŸ’¡ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ (Ù…Ø«Ù„Ø§Ù‹: 5,000 Ø£Ùˆ 5000)
                </p>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
                    <button type="button" class="btn btn-primary" onclick="resetForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
                </div>
            </form>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
        <div class="table-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
            
            <div id="expensesTableContainer">
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ -->
        <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--secondary-black); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gold);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--gold); margin: 0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h2>
                    <button onclick="closeDetailsModal()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold;">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
                
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
            
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="loadExpenseStats('today', event)">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="tab-btn" onclick="loadExpenseStats('week', event)">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="tab-btn" onclick="loadExpenseStats('month', event)">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
            </div>

            <div class="cards-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                    <div class="card-value" id="expenseCount">0</div>
                    <div class="card-label">Ù…ØµØ±ÙˆÙ</div>
                </div>

                <div class="card">
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                    <div class="card-value" id="totalExpenses">0</div>
                    <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>

                <div class="card">
                    <div class="card-title">Ø£Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙ</div>
                    <div class="card-value" id="maxExpense">0</div>
                    <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>

                <div class="card">
                    <div class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
                    <div class="card-value" id="avgExpense">0</div>
                    <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>
            </div>

            <!-- Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Ù‹ -->
            <div id="topExpensesContainer" style="margin-top: 30px;">
                <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Ù‹</h3>
                <div id="topExpensesList" style="background: var(--primary-black); padding: 20px; border-radius: 10px;">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="db.js"></script>
    <script src="auth-check.js"></script>
    <script>
        let editingId = null;
        let currentStatsPeriod = 'today';

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        document.getElementById('date').valueAsDate = new Date();

        // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = this.value;
            
            // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ù„ÙØ§ØµÙ„Ø©
            value = value.replace(/[^0-9.,]/g, '');
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
            value = value.replace(/ØŒ/g, ',');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ø°Ø§ ØªØºÙŠØ±Øª
            if (value !== this.value) {
                const cursorPosition = this.selectionStart;
                this.value = value;
                // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±
                this.setSelectionRange(cursorPosition, cursorPosition);
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù… (Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ Ù„Ù„Ø­Ø³Ø§Ø¨)
            const numericValue = value.replace(/,/g, '');
            const amount = parseFloat(numericValue) || 0;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            document.getElementById('displayAmount').textContent = formatNumber(amount);
        });

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('expensesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const expenseName = document.getElementById('expenseName').value.trim();
            if (!expenseName) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ!', 'danger');
                return;
            }

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù„Ù
            let amountValue = document.getElementById('amount').value.replace(/,/g, ''); // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ù„ÙˆÙ
            const amountFull = parseFloat(amountValue) || 0;
            const amountInThousands = amountFull / 1000; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù„Ù

            const formData = {
                date: document.getElementById('date').value,
                expense_name: expenseName,
                amount: amountInThousands
            };

            try {
                if (editingId) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
                    await db.updateExpense(editingId, formData);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    editingId = null;
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                    await db.addExpense(formData);
                    showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }

                resetForm();
                await loadExpensesTable();
                await loadExpenseStats(currentStatsPeriod);
            } catch (error) {
                console.error('Error saving expense:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'danger');
            }
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        function resetForm() {
            document.getElementById('expensesForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('displayAmount').textContent = '0';
            editingId = null;
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù…Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
        async function loadExpensesTable() {
            const expenses = (await db.getAllExpenses()).sort((a, b) => {
                if (b.date === a.date) {
                    return b.id - a.id;
                }
                return new Date(b.date) - new Date(a.date);
            });
            const tbody = document.getElementById('expensesTableBody');

            if (expenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø§Ø³Ù…
            const grouped = {};
            expenses.forEach(record => {
                const key = `${record.date}_${record.expense_name}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: record.date,
                        expense_name: record.expense_name,
                        total: 0,
                        count: 0,
                        details: []
                    };
                }
                grouped[key].total += record.amount;
                grouped[key].count++;
                grouped[key].details.push(record);
            });

            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ array ÙˆØªØ±ØªÙŠØ¨
            const groupedArray = Object.values(grouped).sort((a, b) => {
                if (b.date === a.date) {
                    return b.details[0].id - a.details[0].id;
                }
                return new Date(b.date) - new Date(a.date);
            });

            tbody.innerHTML = groupedArray.map(group => {
                const hasMultiple = group.count > 1;
                const detailsKey = `${group.date}_${group.expense_name}`;
                
                return `
                    <tr>
                        <td>${group.date}</td>
                        <td><strong>${group.expense_name}</strong></td>
                        <td><strong style="color: var(--gold);">${formatThousands(group.total)}</strong></td>
                        <td>${group.count} ${group.count > 1 ? 'Ù…Ø±Ø§Øª' : 'Ù…Ø±Ø©'}</td>
                        <td>
                            ${hasMultiple ? 
                                `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem; margin-bottom: 5px;" onclick="showDetails('${detailsKey}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button><br>` 
                                : ''}
                            ${group.count === 1 ? 
                                `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;" onclick="editExpense(${group.details[0].id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                 <button class="btn btn-danger" onclick="deleteExpense(${group.details[0].id})">Ø­Ø°Ù</button>`
                                : `<button class="btn btn-danger" onclick="deleteGroupExpenses('${detailsKey}')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            window.groupedExpenses = grouped;
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ
        function showDetails(key) {
            const group = window.groupedExpenses[key];
            if (!group) return;

            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');

            content.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: var(--primary-black); border-radius: 10px;">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">${group.expense_name}</h3>
                    <p style="color: var(--light-gray);">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${group.date}</p>
                    <p style="color: var(--light-gray);">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: ${group.count}</p>
                    <p style="color: var(--gold); font-size: 1.3rem; font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatThousands(group.total)} Ø¯ÙŠÙ†Ø§Ø±</p>
                </div>

                <h3 style="color: var(--gold); margin-bottom: 15px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</h3>
                
                ${group.details.map((detail, index) => `
                    <div style="background: var(--primary-black); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--white); font-weight: bold;">Ø§Ù„Ù…Ø±Ø© ${index + 1}</div>
                            <div style="color: var(--gold); font-size: 1.2rem; margin-top: 5px;">${formatThousands(detail.amount)} Ø¯ÙŠÙ†Ø§Ø±</div>
                        </div>
                        <div>
                            <button class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9rem; margin-left: 5px;" onclick="editExpenseFromModal(${detail.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" style="padding: 5px 15px; font-size: 0.9rem;" onclick="deleteExpenseFromModal(${detail.id})">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `).join('')}
            `;

            modal.style.display = 'flex';
        }

        // Ø¥ØºÙ„Ø§Ù‚ Modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Modal
        function editExpenseFromModal(id) {
            closeDetailsModal();
            editExpense(id);
        }

        // Ø­Ø°Ù Ù…Ù† Modal
        async function deleteExpenseFromModal(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
                try {
                    await db.deleteExpense(id);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    closeDetailsModal();
                    await loadExpensesTable();
                    await loadExpenseStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // Ø­Ø°Ù Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø©
        async function deleteGroupExpenses(key) {
            const group = window.groupedExpenses[key];
            if (!group) return;

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù…ØµØ§Ø±ÙŠÙ "${group.expense_name}" ÙÙŠ ${group.date}ØŸ\n(${group.count} Ù…ØµØ§Ø±ÙŠÙ - Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${formatThousands(group.total)} Ø¯ÙŠÙ†Ø§Ø±)`)) {
                try {
                    for (const detail of group.details) {
                        await db.deleteExpense(detail.id);
                    }
                    showAlert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    await loadExpensesTable();
                    await loadExpenseStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting expenses:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailsModal();
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        async function loadExpenseStats(period, e = null) {
            currentStatsPeriod = period;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            if (e && e.target) {
                e.target.classList.add('active');
            } else {
                // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ØŒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©
                const buttons = document.querySelectorAll('.tab-btn');
                if (period === 'today') buttons[0]?.classList.add('active');
                else if (period === 'week') buttons[1]?.classList.add('active');
                else if (period === 'month') buttons[2]?.classList.add('active');
            }

            const expenses = await db.getAllExpenses();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            let periodAgo = new Date();
            const today = new Date().toISOString().split('T')[0];
            
            if (period === 'today') {
                periodAgo = new Date();
            } else if (period === 'week') {
                periodAgo.setDate(periodAgo.getDate() - 7);
            } else if (period === 'month') {
                periodAgo.setMonth(periodAgo.getMonth() - 1);
            }
            const periodAgoStr = periodAgo.toISOString().split('T')[0];
            
            const periodExpenses = period === 'today' 
                ? expenses.filter(e => e.date === today)
                : expenses.filter(e => e.date >= periodAgoStr);
            
            // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const count = periodExpenses.length;
            const total = periodExpenses.reduce((sum, e) => sum + e.amount, 0);
            const max = count > 0 ? Math.max(...periodExpenses.map(e => e.amount)) : 0;
            const avg = count > 0 ? total / count : 0;

            document.getElementById('expenseCount').textContent = formatNumber(count, 0);
            document.getElementById('totalExpenses').textContent = formatThousands(total);
            document.getElementById('maxExpense').textContent = formatThousands(max);
            document.getElementById('avgExpense').textContent = formatThousands(avg);

            // Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Ù‹
            loadTopExpenses(periodExpenses);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Ù‹
        function loadTopExpenses(expenses) {
            if (expenses.length === 0) {
                document.getElementById('topExpensesList').innerHTML = `
                    <p style="text-align: center; color: var(--light-gray);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                `;
                return;
            }

            // Ø¬Ù…Ø¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
            const expensesByName = {};
            expenses.forEach(e => {
                const name = e.expense_name;
                if (!expensesByName[name]) {
                    expensesByName[name] = {
                        name: name,
                        count: 0,
                        total: 0
                    };
                }
                expensesByName[name].count++;
                expensesByName[name].total += e.amount;
            });

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const sorted = Object.values(expensesByName).sort((a, b) => b.total - a.total);
            const top5 = sorted.slice(0, 5);

            document.getElementById('topExpensesList').innerHTML = top5.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 10px; background: var(--secondary-black); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 1.5rem; color: var(--gold); font-weight: bold;">${index + 1}</span>
                        <div>
                            <div style="color: var(--white); font-weight: bold;">${item.name}</div>
                            <div style="color: var(--light-gray); font-size: 0.9rem;">${item.count} Ù…Ø±Ø©</div>
                        </div>
                    </div>
                    <div style="text-align: left;">
                        <div style="color: var(--gold); font-size: 1.3rem; font-weight: bold;">${formatThousands(item.total)}</div>
                        <div style="color: var(--light-gray); font-size: 0.9rem;">Ø¯ÙŠÙ†Ø§Ø±</div>
                    </div>
                </div>
            `).join('');
        }

        // ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ
        async function editExpense(id) {
            const expenses = await db.getAllExpenses();
            const record = expenses.find(e => e.id === id);
            
            if (record) {
                // ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
                const amountFull = record.amount * 1000;
                
                document.getElementById('date').value = record.date;
                document.getElementById('expenseName').value = record.expense_name;
                document.getElementById('amount').value = formatNumber(amountFull); // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ÙÙˆØ§ØµÙ„
                document.getElementById('displayAmount').textContent = formatNumber(amountFull);
                editingId = id;
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Ø­Ø°Ù Ù…ØµØ±ÙˆÙ
        async function deleteExpense(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
                try {
                    await db.deleteExpense(id);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    await loadExpensesTable();
                    await loadExpenseStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting expense:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', async () => {
            await loadExpensesTable();
            await loadExpenseStats('today');
        });
    </script>
</body>
</html>
