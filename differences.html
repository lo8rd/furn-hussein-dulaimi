<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª - ÙØ±Ù† Ø­Ø³ÙŠÙ† Ø§Ù„Ø¯Ù„ÙŠÙ…ÙŠ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <button onclick="logout()" class="logout-btn">
                <span>ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
            <h1>ğŸ“‰ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ğŸ“‰</h1>
            <p>ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ…ÙˆÙ†</p>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="dough.html">Ø§Ù„Ø¹Ø¬Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</a></li>
                <li><a href="electric.html"> Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</a></li>
                <li><a href="differences.html" class="active">Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</a></li>
                <li><a href="dough_records.html">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø¬Ù†Ø§Øª</a></li>
                <li><a href="expenses.html">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</a></li>
                <li><a href="profit.html">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</a></li>
            </ul>
        </nav>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ÙØ±ÙˆÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© ÙØ±ÙˆÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h2>
            
            <div id="alertMessage"></div>

            <form id="differencesForm">
                <div class="form-group">
                    <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="type">Ù†ÙˆØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª / Ø§Ù„Ø¬Ù‡Ø©</label>
                    <input type="text" id="type" name="type" list="typesList" placeholder="Ù…Ø«Ø§Ù„: ØªÙ„ÙØŒ Ù…Ø·Ø¹Ù…ØŒ ÙƒØ§ÙØªÙŠØ±ÙŠØ§ØŒ Ù…Ø­Ù„..." required>
                    <datalist id="typesList">
                        <option value="ØªÙ„Ù">
                        <option value="Ù…Ø·Ø¹Ù…">
                        <option value="ÙƒØ§ÙØªÙŠØ±ÙŠØ§">
                        <option value="Ù…Ø­Ù„">
                        <option value="Ø²Ø¨ÙˆÙ†">
                    </datalist>
                    <small style="color: var(--light-gray); display: block; margin-top: 5px;">
                        ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¬Ù‡Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
                    </small>
                </div>

                <div class="form-group">
                    <label for="count">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ…ÙˆÙ†</label>
                    <input type="number" id="count" name="count" min="0" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯" required>
                </div>

                <div class="cards-grid" style="grid-template-columns: 1fr;">
                    <div class="card">
                        <div class="card-title">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­Ø³ÙˆØ¨</div>
                        <div class="card-value" id="displayAmount">0</div>
                        <div class="card-label">Ø£Ù„Ù Ø¯ÙŠÙ†Ø§Ø± (Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ…ÙˆÙ† Ã· 8)</div>
                    </div>
                </div>

                <p style="text-align: center; color: var(--light-gray); margin-top: 15px; font-size: 0.9rem;">
                    ğŸ’¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¨Ø§Ù„Ø£Ù„Ù Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ØªØ¨Ø³ÙŠØ· (Ù…Ø«Ù„Ø§Ù‹: 15 = 15,000 Ø¯ÙŠÙ†Ø§Ø±)
                </p>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</button>
                    <button type="button" class="btn btn-primary" onclick="resetForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
                </div>
            </form>
        </div>

        <!-- Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ… -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ…ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠ</div>
                    <div class="card-value" id="todayTotalCount">0</div>
                    <div class="card-label">ØµÙ…ÙˆÙ†</div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, var(--danger) 0%, #8b0000 100%);">
                    <div class="card-title" style="color: var(--white);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    <div class="card-value" id="todayTotalAmount" style="color: var(--white); font-size: 2.5rem;">0</div>
                    <div class="card-label" style="color: var(--white);">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
        <div class="table-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø³Ø¬Ù„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</h2>
            
            <div id="differencesTableContainer">
                <table id="differencesTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹ / Ø§Ù„Ø¬Ù‡Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ…ÙˆÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="differencesTableBody">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª -->
        <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--secondary-black); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gold);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--gold); margin: 0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</h2>
                    <button onclick="closeDetailsModal()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold;">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
                
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª -->
        <div class="form-container">
            <h2 style="color: var(--gold); margin-bottom: 20px;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª</h2>
            
            <div class="stats-tabs">
                <button class="tab-btn active" onclick="loadDifferenceStats('today', event)">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="tab-btn" onclick="loadDifferenceStats('week', event)">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="tab-btn" onclick="loadDifferenceStats('month', event)">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
            </div>

            <div class="cards-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                    <div class="card-value" id="recordCount">0</div>
                    <div class="card-label">Ø³Ø¬Ù„</div>
                </div>

                <div class="card">
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ…ÙˆÙ†</div>
                    <div class="card-value" id="totalCount">0</div>
                    <div class="card-label">ØµÙ…ÙˆÙ†</div>
                </div>

                <div class="card">
                    <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</div>
                    <div class="card-value" id="totalAmount">0</div>
                    <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>

                <div class="card">
                    <div class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨Ù„Øº</div>
                    <div class="card-value" id="avgAmount">0</div>
                    <div class="card-label">Ø¯ÙŠÙ†Ø§Ø±</div>
                </div>
            </div>

            <!-- Ø£ÙƒØ«Ø± Ø§Ù„Ø¬Ù‡Ø§Øª ÙØ±ÙˆÙ‚Ø§Øª -->
            <div id="topTypesContainer" style="margin-top: 30px;">
                <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">Ø£ÙƒØ«Ø± Ø§Ù„Ø¬Ù‡Ø§Øª ÙØ±ÙˆÙ‚Ø§Øª</h3>
                <div id="topTypesList" style="background: var(--primary-black); padding: 20px; border-radius: 10px;">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="db.js"></script>
    <script src="auth-check.js"></script>
    <script>
        let editingId = null;
        let currentStatsPeriod = 'today';

        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        document.getElementById('date').valueAsDate = new Date();

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
        document.getElementById('count').addEventListener('input', function() {
            const count = parseInt(this.value) || 0;
            const amount = count / 8;
            document.getElementById('displayAmount').textContent = formatThousands(amount);
        });

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Ù„Ù„Ø­ÙØ¸)
        function convertTypeToEnglish(arabicType) {
            const typeMap = {
                'ØªÙ„Ù': 'waste',
                'Ù‡Ø¯Ø±': 'waste',
                'Ù…Ø·Ø¹Ù…': 'restaurant',
                'ÙƒØ§ÙØªÙŠØ±ÙŠØ§': 'restaurant',
                'Ù…Ø­Ù„': 'restaurant',
                'Ø²Ø¨ÙˆÙ†': 'restaurant',
                'Ø¹Ù…ÙŠÙ„': 'restaurant'
            };
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… 'other'
            return typeMap[arabicType.trim()] || 'other';
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù„Ù„Ø¹Ø±Ø¶)
        function convertTypeToArabic(englishType) {
            const typeMap = {
                'waste': 'Ù‡Ø¯Ø±/ØªÙ„Ù',
                'restaurant': 'Ù…Ø·Ø§Ø¹Ù…/Ù…Ø­Ù„Ø§Øª',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            
            return typeMap[englishType] || englishType;
        }

        document.getElementById('differencesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const typeInput = document.getElementById('type').value.trim();
            if (!typeInput) {
                showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª!', 'danger');
                return;
            }

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
            const typeEnglish = convertTypeToEnglish(typeInput);

            const formData = {
                date: document.getElementById('date').value,
                type: typeEnglish, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                count: document.getElementById('count').value
            };

            try {
                if (editingId) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
                    await db.updateDifference(editingId, formData);
                    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    editingId = null;
                } else {
                    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                    await db.addDifference(formData);
                    showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }

                resetForm();
                await loadDifferencesTable();
                await loadTodayStats();
                await loadDifferenceStats(currentStatsPeriod);
            } catch (error) {
                console.error('Error saving difference:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'danger');
            }
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        function resetForm() {
            document.getElementById('differencesForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('displayAmount').textContent = '0';
            editingId = null;
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
        async function loadDifferencesTable() {
            const differences = (await db.getAllDifferences()).sort((a, b) => {
                if (b.date === a.date) {
                    return b.id - a.id;
                }
                return new Date(b.date) - new Date(a.date);
            });
            const tbody = document.getElementById('differencesTableBody');

            if (differences.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆÙ‚Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù†ÙˆØ¹
            const grouped = {};
            differences.forEach(record => {
                const key = `${record.date}_${record.type}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: record.date,
                        type: record.type,
                        totalCount: 0,
                        totalAmount: 0,
                        count: 0,
                        details: []
                    };
                }
                grouped[key].totalCount += (record.quantity || record.count || 0);
                grouped[key].totalAmount += (record.total_value || record.amount || 0) / 1000; // ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø¯ÙŠÙ†Ø§Ø± Ø¥Ù„Ù‰ Ø£Ù„Ù Ø¯ÙŠÙ†Ø§Ø±
                grouped[key].count++;
                grouped[key].details.push(record);
            });

            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ array ÙˆØªØ±ØªÙŠØ¨
            const groupedArray = Object.values(grouped).sort((a, b) => {
                if (b.date === a.date) {
                    return b.details[0].id - a.details[0].id;
                }
                return new Date(b.date) - new Date(a.date);
            });

            tbody.innerHTML = groupedArray.map(group => {
                const hasMultiple = group.count > 1;
                const detailsKey = `${group.date}_${group.type}`;
                
                return `
                    <tr>
                        <td>${group.date}</td>
                        <td><strong style="color: var(--gold);">${convertTypeToArabic(group.type)}</strong></td>
                        <td><strong>${formatNumber(group.totalCount, 0)}</strong></td>
                        <td><strong style="color: var(--danger);">${formatThousands(group.totalAmount)}</strong></td>
                        <td>${group.count} ${group.count > 1 ? 'Ù…Ø±Ø§Øª' : 'Ù…Ø±Ø©'}</td>
                        <td>
                            ${hasMultiple ? 
                                `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem; margin-bottom: 5px;" onclick="showDetails('${detailsKey}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button><br>` 
                                : ''}
                            ${group.count === 1 ? 
                                `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;" onclick="editRecord(${group.details[0].id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                 <button class="btn btn-danger" onclick="deleteRecord(${group.details[0].id})">Ø­Ø°Ù</button>`
                                : `<button class="btn btn-danger" onclick="deleteGroupDifferences('${detailsKey}')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            window.groupedDifferences = grouped;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
        async function loadTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = await db.getDifferencesByDate(today);

            const totalCount = todayRecords.reduce((sum, r) => sum + (r.quantity || r.count || 0), 0);
            const totalAmount = todayRecords.reduce((sum, r) => sum + (r.total_value || r.amount || 0), 0);

            document.getElementById('todayTotalCount').textContent = formatNumber(totalCount, 0);
            document.getElementById('todayTotalAmount').textContent = formatNumber(totalAmount, 0);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
        async function loadDifferenceStats(period, e = null) {
            currentStatsPeriod = period;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (e && e.target) {
                e.target.classList.add('active');
            } else {
                const buttons = document.querySelectorAll('.tab-btn');
                if (period === 'today') buttons[0]?.classList.add('active');
                else if (period === 'week') buttons[1]?.classList.add('active');
                else if (period === 'month') buttons[2]?.classList.add('active');
            }

            const differences = await db.getAllDifferences();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            let periodAgo = new Date();
            const today = new Date().toISOString().split('T')[0];
            
            if (period === 'today') {
                periodAgo = new Date();
            } else if (period === 'week') {
                periodAgo.setDate(periodAgo.getDate() - 7);
            } else if (period === 'month') {
                periodAgo.setMonth(periodAgo.getMonth() - 1);
            }
            const periodAgoStr = periodAgo.toISOString().split('T')[0];
            
            const periodDifferences = period === 'today' 
                ? differences.filter(d => d.date === today)
                : differences.filter(d => d.date >= periodAgoStr);
            
            // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const count = periodDifferences.length;
            const totalCount = periodDifferences.reduce((sum, d) => sum + d.count, 0);
            const totalAmount = periodDifferences.reduce((sum, d) => sum + d.amount, 0);
            const avg = count > 0 ? totalAmount / count : 0;

            document.getElementById('recordCount').textContent = formatNumber(count, 0);
            document.getElementById('totalCount').textContent = formatNumber(totalCount, 0);
            document.getElementById('totalAmount').textContent = formatThousands(totalAmount);
            document.getElementById('avgAmount').textContent = formatThousands(avg);

            // Ø£ÙƒØ«Ø± Ø§Ù„Ø¬Ù‡Ø§Øª ÙØ±ÙˆÙ‚Ø§Øª
            loadTopTypes(periodDifferences);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£ÙƒØ«Ø± Ø§Ù„Ø¬Ù‡Ø§Øª ÙØ±ÙˆÙ‚Ø§Øª
        function loadTopTypes(differences) {
            if (differences.length === 0) {
                document.getElementById('topTypesList').innerHTML = `
                    <p style="text-align: center; color: var(--light-gray);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                `;
                return;
            }

            // Ø¬Ù…Ø¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ø¬Ù‡Ø©
            const typesByName = {};
            differences.forEach(d => {
                const name = d.type;
                if (!typesByName[name]) {
                    typesByName[name] = {
                        name: name,
                        count: 0,
                        totalAmount: 0
                    };
                }
                typesByName[name].count += d.count;
                typesByName[name].totalAmount += d.amount;
            });

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
            const sorted = Object.values(typesByName).sort((a, b) => b.totalAmount - a.totalAmount);
            const top5 = sorted.slice(0, 5);

            document.getElementById('topTypesList').innerHTML = top5.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 10px; background: var(--secondary-black); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 1.5rem; color: var(--gold); font-weight: bold;">${index + 1}</span>
                        <div>
                            <div style="color: var(--white); font-weight: bold;">${item.name}</div>
                            <div style="color: var(--light-gray); font-size: 0.9rem;">${formatNumber(item.count)} ØµÙ…ÙˆÙ†</div>
                        </div>
                    </div>
                    <div style="text-align: left;">
                        <div style="color: var(--danger); font-size: 1.3rem; font-weight: bold;">${formatThousands(item.totalAmount)}</div>
                        <div style="color: var(--light-gray); font-size: 0.9rem;">Ø¯ÙŠÙ†Ø§Ø±</div>
                    </div>
                </div>
            `).join('');
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
        function showDetails(key) {
            const group = window.groupedDifferences[key];
            if (!group) return;

            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');

            content.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: var(--primary-black); border-radius: 10px;">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">${convertTypeToArabic(group.type)}</h3>
                    <p style="color: var(--light-gray);">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${group.date}</p>
                    <p style="color: var(--light-gray);">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: ${group.count}</p>
                    <p style="color: var(--light-gray);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ…ÙˆÙ†: ${formatNumber(group.totalCount, 0)} ØµÙ…ÙˆÙ†</p>
                    <p style="color: var(--danger); font-size: 1.3rem; font-weight: bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatThousands(group.totalAmount)} Ø¯ÙŠÙ†Ø§Ø±</p>
                </div>

                <h3 style="color: var(--gold); margin-bottom: 15px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</h3>
                
                ${group.details.map((detail, index) => `
                    <div style="background: var(--primary-black); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--white); font-weight: bold;">Ø§Ù„Ù…Ø±Ø© ${index + 1}</div>
                            <div style="color: var(--light-gray); margin-top: 5px;">${formatNumber(detail.quantity || detail.count || 0, 0)} ØµÙ…ÙˆÙ†</div>
                            <div style="color: var(--danger); font-size: 1.2rem; margin-top: 5px;">${formatNumber((detail.total_value || detail.amount || 0), 0)} Ø¯ÙŠÙ†Ø§Ø±</div>
                        </div>
                        <div>
                            <button class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9rem; margin-left: 5px;" onclick="editDifferenceFromModal(${detail.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" style="padding: 5px 15px; font-size: 0.9rem;" onclick="deleteDifferenceFromModal(${detail.id})">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `).join('')}
            `;

            modal.style.display = 'flex';
        }

        // Ø¥ØºÙ„Ø§Ù‚ Modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Modal
        function editDifferenceFromModal(id) {
            closeDetailsModal();
            editRecord(id);
        }

        // Ø­Ø°Ù Ù…Ù† Modal
        async function deleteDifferenceFromModal(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                try {
                    await db.deleteDifference(id);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    closeDetailsModal();
                    await loadDifferencesTable();
                    await loadTodayStats();
                    await loadDifferenceStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting difference:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // Ø­Ø°Ù Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø©
        async function deleteGroupDifferences(key) {
            const group = window.groupedDifferences[key];
            if (!group) return;

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙØ±ÙˆÙ‚Ø§Øª "${group.type}" ÙÙŠ ${group.date}ØŸ\n(${group.count} ÙØ±ÙˆÙ‚Ø§Øª - Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${formatNumber(group.totalCount, 0)} ØµÙ…ÙˆÙ† - ${formatThousands(group.totalAmount)} Ø¯ÙŠÙ†Ø§Ø±)`)) {
                try {
                    for (const detail of group.details) {
                        await db.deleteDifference(detail.id);
                    }
                    showAlert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    await loadDifferencesTable();
                    await loadTodayStats();
                    await loadDifferenceStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting differences:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailsModal();
            }
        });

        // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„
        async function editRecord(id) {
            const differences = await db.getAllDifferences();
            const record = differences.find(d => d.id === id);
            
            if (record) {
                document.getElementById('date').value = record.date;
                document.getElementById('type').value = record.type;
                document.getElementById('count').value = (record.quantity || record.count || 0);
                document.getElementById('displayAmount').textContent = formatThousands((record.total_value || record.amount || 0) / 1000);
                editingId = id;
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Ø­Ø°Ù Ø³Ø¬Ù„
        async function deleteRecord(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                try {
                    await db.deleteDifference(id);
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    await loadDifferencesTable();
                    await loadTodayStats();
                    await loadDifferenceStats(currentStatsPeriod);
                } catch (error) {
                    console.error('Error deleting difference:', error);
                    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'danger');
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDifferencesTable();
            await loadTodayStats();
            await loadDifferenceStats('today');
        });
    </script>
</body>
</html>

